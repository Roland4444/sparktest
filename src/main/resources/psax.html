<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Таблица ПСА</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="style2.css">
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://use.fontawesome.com/a0f7b43176.js"></script>
    <!-- Не используйте это в production -->
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

    <!-- jQuery and JS bundle w/ Popper.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>


    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>
<nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <form class="form-inline">

    </form>

    <div class="btn-group  mr-sm-2">
        <button type="button" class="btn btn-sq-sm btn-light dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fa fa-user fa-2x">$user</i><br>
        </button>
        <div class="dropdown-menu">
            <a class="dropdown-item"   data-toggle="modal"  data-target="#gridSystemModal">Сменить пароль</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/logout">Выйти</a>
        </div>
    </div>
</nav>

<!--nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div class="bd-example bd-example-padded-bottom">
        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal"  data-target="#gridSystemModal">
            Сменить пароль
        </button>
    </div>
</nav-->



<!--div id="loginform" class="logindiv">
    <form action="approve" >
        <h5>ID</h5><input name="id" id="inputid"> </input><br>
        <button type="submit" onclick="alert('Запрос одобрен')" >Одобрить запрос</button>
    </form>
</div-->

<div id="gridSystemModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Изменение пароля</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">

                    <p>Введите новый пароль<input type="password" class="float-right" id="pass1">     <br>
                    <p>Повторите пароль<input type="password" class="float-right" id="pass2">     <br><br>
                        <button  class="btn btn-secondary" align="center" onclick="changepass()">Изменить пароль</button><button type="button" class="btn btn-secondary float-right" data-dismiss="modal">Закрыть</button>

                </div>
            </div>
            <div class="modal-footer">

            </div>
        </div>
    </div>



</div>
<button onclick="openmodal()">Show modal</button>
<button onclick="createdynamical()">Dinamical create</button>
<button onclick="checkpassport()">

<table  id="mTable" border="10" cellpadding="10"  align="center" valign="center" class="table">
    <th class="text-center">ID</th>
    <th class="text-center">Дата</th>
    <th class="text-center">ПЗУ</th>
    <th class="text-center">Номер ПСА</th>
    <th class="text-center">Клиент</th>
    <th class="text-center">Номер машины</th>
    <th class="text-center">Металл</th>
    <th class="text-center">Масса, кг</th>
    <th class="text-center">Сумма, руб</th>
    <th class="text-center">Действия</th>
    <tbody id="tbody">
    <tr><td>fgfg-hjjhh</td>
        <td>12.03.2010</td>
        <td>#3</td>
        <td>12066</td>
        <td>Конкин</td>
        <td>!2ОСНЕХАЙ</td>
        <td>Золото</td>
        <td>20</td>
        <td>500000000</td>
        <td><button id="confirm2" type="button" class="btn btn-success" onclick="setup($idbutton)" л><i class="fa fa-hand-pointer-o" aria-hidden="true"></i>
            Установить контрагента</button>
    </div></td>
    </tr>    

    </tbody>
</table>

<script>
function checkpassport(serianumber){
        var xhr__ = new XMLHttpRequest()
        const params = "name="+name+"&psanumber="+initial+"&idclient="+value+"&type="+key;
        var url = "passport.avs.com.ru"
        alert(request)
        xhr.open("POST", url, true);
//В заголовке говорим что тип передаваемых данных закодирован.
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        xhr.addEventListener("readystatechange", () => {

        if(request.readyState === 4 && request.status === 200) {
		    console.log(request.responseText);
        }
        });

//	Вот здесь мы и передаем строку с данными, которую формировали выше. И собственно выполняем запрос.
        xhr.send(params);
}



    let json_ = '{"id":"GGGGHHH","datetime":"12.03.2020","department":"KUTUM","psanumber":"1206","client":"АО МЕГАФОН", "platenumber":"FF12RX",\
    "metals":"БРОНЗА", "uuid":"126103"}';
    var obj = JSON.parse(json_);
    let index____ = 0
    function createRow(a){
        var table = document.getElementById("mTable");
        var row = table.insertRow(1);
        var tbdy = document.getElementById('tbody');
        var tr = document.createElement('tr');
        tr.setAttribute("id", index____);
        for (var j = 0; j < 9; j++)
        {
            var td = document.createElement('td');
            td.setAttribute("align", "center");
            var div = document.createElement("div");
            var id = index____+'a'+j
            console.log(id)
            div.setAttribute("id", id);
            td.appendChild(div)
            tr.appendChild(td)
        }
        var td = document.createElement('td');
        var btn = document.createElement("button");
        
        var id = index____+'a9'
        btn.setAttribute("id", id);
        btn.setAttribute("class", "btn btn-success");
        btn.innerHTML = '<i class="fa fa-hand-pointer-o" aria-hidden="true"></i>Установить контрагента'
        td.appendChild(btn)
        tr.appendChild(td)
        tbdy.prepend(tr);
        alert('create row success!')
        }

    function applyusinguuid(a){
        alert("UUID::"+a);
    }


    function fillRow(a)
    {
         ////   alert('in fillRow')

       
     ///////  alert(index____)
       var id = document.getElementById(index____+'a'+0);
       var datetime_ = document.getElementById(index____+'a'+1);
       var department = document.getElementById(index____+'a'+2);
       var psanumber = document.getElementById(index____+'a'+3);
       var client = document.getElementById(index____+'a'+4);
       var platenumber = document.getElementById(index____+'a'+5);
       var metals = document.getElementById(index____+'a'+6);
       var mass = document.getElementById(index____+'a'+7);
       var summ = document.getElementById(index____+'a'+8);
       var approvebutton = document.getElementById(index____+'a'+9);
       id.innerHTML =a.id
       datetime_.innerHTML =a.datetime
       department.innerHTML =a.department
       psanumber.innerHTML=a.psanumber
       client.innerHTML=a.client
       platenumber.innerHTML = a.platenumber
       metals.innerHTML =a.metals
       mass.innerHTML =''
       summ.innerHTML = ''
       approvebutton.setAttribute("onclick", "openmodal("+a.uuid+")")
       alert('fill row success!')

    }    
    
    function dinamicalloadJSON(q){
        
        var obj = JSON.parse(q)
        for (var item in obj){
            var id  = (obj[item].id);
            createRow(obj[item])
        }
    }


    function createdynamical(){

        alert('tupple')
        index____ = 500
        createRow(obj)
        fillRow(obj)
      
    };

    function setup(a){
        alert("its worked!"+a)
        var node = evt.target || evt.srcElement;
        if (node.name == 'edit') {
        node.value = "Modify";
    }
    }

    </script>

<div id="dialog" title="Basic dialog">
    <h3> Введите ИНН или Номер паспорта</h3>
    <input align="center" id="googlesearch" onkeyup="search()" class="searchclient2">
    <div id="client"></div>
    <button id="confirm" type="button" class="btn btn-success" onclick="apply()" л><i class="fa fa-hand-pointer-o" aria-hidden="true"></i>
        Установить контрагента</button>
</div>

<script>
   let initial =20
   alert(initial)
   let name =""
   let key =""
   let value =""
   let confirm = document.getElementById("confirm")
   confirm.style.visibility = 'hidden'


let divid = document.getElementById("dialog")

divid.style.visibility = 'hidden'
function openmodal(a){
initial =a
///$("#dialog").dialog({ width: 1000 });
    divid.style.visibility = 'visible'
 ///   alert('show modal')
    $( function() {
    $( "#dialog" ).dialog({ width: 600 });

  } );
}
</script>

<script>

function search(){
    function getXmlHttp()
    {
        var xmlhttp;
        try {
        xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
        } catch (e)
        {
            try
        {
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            } catch (E)
        {
            xmlhttp = false;
        }
            }
            if (!xmlhttp && typeof XMLHttpRequest!='undefined')
            {
                xmlhttp = new XMLHttpRequest();
            }
            return xmlhttp;
        }

        var xhr = getXmlHttp()
        var request = "/psaproc?input="+googlesearch.value;
        console.log('sending  ' +googlesearch.value)
        xhr.open("GET", request, true);
        xhr.onreadystatechange=function()
        {
            if (xhr.readyState != 4) return
            clearTimeout(xhrTimeout)
            if (xhr.status == 200) {
                let elem = document.getElementById("client")
                let resp = xhr.responseText
                console.log("responce::\n"+resp)
                name = resp.substring(0, resp.indexOf('::{')).replaceAll("#"," ")
                console.log(name)
                let data = resp.substring(resp.indexOf('::{')+3, resp.indexOf('}.'))
                console.log("data\n"+data)
                console.log('key::'+ getKey(data))
                console.log('value::'+ getValue(data))

                key = getKey(data)
                value = getValue(data)
                elem.innerHTML = "<h3>"+name.replaceAll("#"," ")+"</h3>"
                if (xhr.responseText !="")
                    confirm.style.visibility = 'visible'
                else
                    confirm.style.visibility = 'hidden'

                console.log("responce::   "+xhr.responseText)
               //// alert('ответ отправлен');
  /////////////              location.reload();
            }
            if (xhr.status == 500) {
           //////     alert('ответ отправлен');
 ////////////               location.reload();
            }
        }

        xhr.send("a=5&b=4");
        var xhrTimeout = setTimeout( function(){ xhr.abort(); handleError("Timeout") }, 10000);

        function handleError(message)
        {
            alert("Ошибка: "+message)
        }

      }

      search()
function apply(){


   //     get("/psasetclient", (req,res)-> {
   //         var name  = req.queryParams("name");
   //         var psanumber  = req.queryParams("psanumber");
   //         var idclient  = req.queryParams("idclient");
   //         var type = req.queryParams("idclient");

        var xhr = new XMLHttpRequest()
        var request = "/psasetclient?name="+name+"&psanumber="+initial+"&idclient="+value+"&type="+key;
        const params = "name="+name+"&psanumber="+initial+"&idclient="+value+"&type="+key;
        var url = "psasetclient"
        alert(request)
        xhr.open("POST", url, true);
//В заголовке говорим что тип передаваемых данных закодирован.
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        xhr.addEventListener("readystatechange", () => {

        if(request.readyState === 4 && request.status === 200) {
		    console.log(request.responseText);
        }
        });

//	Вот здесь мы и передаем строку с данными, которую формировали выше. И собственно выполняем запрос.
        xhr.send(params);

}


function getValue(input){
    let index = input.indexOf(":")
    return Atom(input.substring(index+1, input.length));
}


function getKey(input___){
    let index = input___.indexOf(":");
    let key = input___.substring(0, index).replaceAll(" ","");
    return Atom(key);
}

function Atom(input){
    return (input.replaceAll("'",""));
}




</script>
</body>
</html>
